#!/usr/bin/env bash
# deb-repo-init.sh - Initialize local Debian package repository following XDG conventions
# Managed by ChezMoi. Do not edit.
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::

{{- if .isUbuntu }}
set -eo pipefail

# Load logger library
HERE="$( cd -- "$( dirname -- "${BASH_SOURCE[0]:-$0}"; )" \
    &> /dev/null && pwd 2> /dev/null; )";
. "${HERE}/../lib/logger/core.bash"

# Configuration following XDG conventions with APT-accessible location
DEB_REPO_DIR="/var/cache/apt/local-repo"
POOL_DIR="${DEB_REPO_DIR}/pool"
DISTS_DIR="${DEB_REPO_DIR}/dists"
CACHE_DIR="{{ env "XDG_CACHE_HOME" | default (printf "%s/.cache" .chezmoi.homeDir) }}/deb"
CONFIG_DIR="{{ env "XDG_CONFIG_HOME" | default (printf "%s/.config" .chezmoi.homeDir) }}/deb"
USER_REPO_LINK="{{ .chezmoi.homeDir }}/.local/share/deb"

# Repository metadata
REPO_CODENAME="local"
REPO_COMPONENT="main"
REPO_ARCHITECTURE="amd64"
REPO_ORIGIN="Local Repository"
REPO_LABEL="local-deb-repo"
REPO_DESCRIPTION="Local Debian package repository"

# APT sources configuration
APT_SOURCES_FILE="/etc/apt/sources.list.d/local-deb-repo.list"
SOURCES_ENTRY="deb [trusted=yes] file://${DEB_REPO_DIR} ${REPO_CODENAME} ${REPO_COMPONENT}"

# Function to check dependencies
check_dependencies() {
    local missing_deps=()
    local required_deps=("dpkg-scanpackages" "gzip" "apt-ftparchive")

    for dep in "${required_deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            missing_deps+=("$dep")
        fi
    done

    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        logger::error "Missing dependencies: ${missing_deps[*]}"
        logger::info "Install with: sudo apt install dpkg-dev apt-utils"
        return 1
    fi

    return 0
}

# Function to initialize repository structure
init_repo_structure() {
    logger::info "Initializing local deb repository structure..."

    # Create repository directory with proper ownership
    sudo mkdir -p "${DEB_REPO_DIR}"
    sudo mkdir -p "${POOL_DIR}/${REPO_COMPONENT}"
    sudo mkdir -p "${DISTS_DIR}/${REPO_CODENAME}/${REPO_COMPONENT}/binary-${REPO_ARCHITECTURE}"
    sudo mkdir -p "${DISTS_DIR}/${REPO_CODENAME}/${REPO_COMPONENT}/source"

    # Create user-accessible directories
    mkdir -p "${CACHE_DIR}"
    mkdir -p "${CONFIG_DIR}"

    # Create symlink in user's home for convenience
    mkdir -p "$(dirname "$USER_REPO_LINK")"
    if [[ ! -L "$USER_REPO_LINK" ]]; then
        ln -sf "$DEB_REPO_DIR" "$USER_REPO_LINK"
        logger::info "Created convenience symlink: $USER_REPO_LINK -> $DEB_REPO_DIR"
    fi

    logger::info "Created repository directories:"
    logger::info "  Repository root: ${DEB_REPO_DIR}"
    logger::info "  Pool: ${POOL_DIR}"
    logger::info "  Distributions: ${DISTS_DIR}"
    logger::info "  Cache: ${CACHE_DIR}"
    logger::info "  Config: ${CONFIG_DIR}"
    logger::info "  User symlink: ${USER_REPO_LINK}"
}

# Function to create repository configuration
create_repo_config() {
    local conf_file="${DISTS_DIR}/${REPO_CODENAME}/Release"

    sudo tee "${conf_file}" > /dev/null << EOF
Origin: ${REPO_ORIGIN}
Label: ${REPO_LABEL}
Codename: ${REPO_CODENAME}
Date: $(date -u '+%a, %d %b %Y %H:%M:%S UTC')
Architectures: ${REPO_ARCHITECTURE}
Components: ${REPO_COMPONENT}
Description: ${REPO_DESCRIPTION}
EOF

    logger::info "Created Release file at ${conf_file}"
}

# Function to create apt-ftparchive configuration
create_ftparchive_config() {
    local ftparchive_conf="${CONFIG_DIR}/apt-ftparchive.conf"

    cat > "${ftparchive_conf}" << EOF
Dir {
    ArchiveDir "${DEB_REPO_DIR}";
    CacheDir "${CACHE_DIR}";
};

TreeDefault {
    Directory "pool/";
};

BinDirectory "pool/${REPO_COMPONENT}" {
    Packages "dists/${REPO_CODENAME}/${REPO_COMPONENT}/binary-${REPO_ARCHITECTURE}/Packages";
    BinOverride "/dev/null";
    ExtraOverride "/dev/null";
};

Default {
    Packages {
        Extensions ".deb";
        Compress ". gzip";
    };
};

Contents {
    Compress "gzip";
};
EOF

    logger::info "Created apt-ftparchive config at ${ftparchive_conf}"
}

# Function to create sources.list entry template
create_sources_list_template() {
    local sources_template="${CONFIG_DIR}/sources.list.local"

    cat > "${sources_template}" << EOF
# Local Debian repository
# Add this line to /etc/apt/sources.list or create a new file in /etc/apt/sources.list.d/
${SOURCES_ENTRY}
EOF

    logger::info "Created sources.list template at ${sources_template}"
}

# Function to add repository to APT sources
add_to_apt_sources() {
    logger::info "Adding repository to APT sources..."

    # Check if entry already exists
    if [[ -f "$APT_SOURCES_FILE" ]]; then
        if grep -qF "${SOURCES_ENTRY}" "$APT_SOURCES_FILE" 2>/dev/null; then
            logger::info "Repository entry already exists in $APT_SOURCES_FILE"
            return 0
        fi
    fi

    # Create the sources.list.d entry
    if sudo tee "$APT_SOURCES_FILE" > /dev/null << EOF
# Local Debian repository
# Generated by deb-repo-init.sh on $(date)
# Repository location: ${DEB_REPO_DIR}
${SOURCES_ENTRY}
EOF
    then
        logger::info "Added repository to $APT_SOURCES_FILE"
        logger::info "Entry: ${SOURCES_ENTRY}"

        # Update APT cache to include the new repository
        logger::info "Updating APT package cache..."
        if sudo apt update; then
            logger::info "APT cache updated successfully"
        else
            logger::warn "APT update completed with some warnings"
        fi
    else
        logger::error "Failed to create $APT_SOURCES_FILE"
        logger::warn "You may need to add the repository manually:"
        logger::warn "  sudo tee $APT_SOURCES_FILE << EOF"
        logger::warn "  ${SOURCES_ENTRY}"
        logger::warn "  EOF"
        return 1
    fi
}

# Function to remove repository from APT sources
remove_from_apt_sources() {
    logger::info "Removing repository from APT sources..."

    if [[ -f "$APT_SOURCES_FILE" ]]; then
        if sudo rm -f "$APT_SOURCES_FILE"; then
            logger::info "Removed $APT_SOURCES_FILE"

            # Update APT cache
            logger::info "Updating APT package cache..."
            sudo apt update >/dev/null 2>&1 || true
        else
            logger::error "Failed to remove $APT_SOURCES_FILE"
            return 1
        fi
    else
        logger::info "APT sources file does not exist: $APT_SOURCES_FILE"
    fi
}

# Function to create .gitignore
create_gitignore() {
    local gitignore_file="${DEB_REPO_DIR}/.gitignore"

    sudo tee "${gitignore_file}" > /dev/null << 'EOF'
# Deb repository .gitignore
# Ignore downloaded packages but keep structure
pool/**/*.deb
pool/**/*.ddeb
pool/**/*.tar.*
pool/**/*.dsc

# Keep important files
!pool/.keep
!dists/
dists/*/Release.gpg
dists/*/InRelease

# Cache files
.cache/
EOF

    logger::info "Created .gitignore at ${gitignore_file}"
}

# Function to create keep files
create_keep_files() {
    sudo touch "${POOL_DIR}/${REPO_COMPONENT}/.keep"
    sudo touch "${DISTS_DIR}/${REPO_CODENAME}/${REPO_COMPONENT}/binary-${REPO_ARCHITECTURE}/.keep"
    logger::info "Created .keep files for empty directories"
}

# Function to set permissions
set_permissions() {
    # Set proper ownership and permissions for APT access
    sudo chown -R root:root "${DEB_REPO_DIR}"
    sudo chmod -R 755 "${DEB_REPO_DIR}"
    sudo find "${DEB_REPO_DIR}" -type f -exec chmod 644 {} \;

    # Ensure _apt user can access the repository
    sudo chmod 755 "${DEB_REPO_DIR}"
    sudo chmod -R a+r "${DEB_REPO_DIR}"

    logger::info "Set appropriate permissions for repository (APT-accessible)"
}

# Function to update package indexes
update_indexes() {
    logger::info "Updating package indexes..."

    # Generate Packages file
    cd "${DEB_REPO_DIR}"
    sudo dpkg-scanpackages -m "pool/${REPO_COMPONENT}" | sudo tee "dists/${REPO_CODENAME}/${REPO_COMPONENT}/binary-${REPO_ARCHITECTURE}/Packages" > /dev/null
    sudo gzip -9c "dists/${REPO_CODENAME}/${REPO_COMPONENT}/binary-${REPO_ARCHITECTURE}/Packages" | sudo tee "dists/${REPO_CODENAME}/${REPO_COMPONENT}/binary-${REPO_ARCHITECTURE}/Packages.gz" > /dev/null

    # Update Release file with checksums
    local release_file="dists/${REPO_CODENAME}/Release"
    local temp_release=$(mktemp)

    # Copy existing Release content except checksums and date
    sudo grep -v "^MD5Sum:\|^SHA1:\|^SHA256:\|^Date:\|^ " "${release_file}" > "${temp_release}" || true

    # Add updated date
    echo "Date: $(date -u '+%a, %d %b %Y %H:%M:%S UTC')" >> "${temp_release}"

    # Add checksums with proper formatting
    echo "MD5Sum:" >> "${temp_release}"
    sudo find "dists/${REPO_CODENAME}" -type f ! -name "Release*" -exec md5sum {} \; | while read -r hash file; do
        size=$(sudo stat -c%s "$file")
        relative_path="${file#dists/${REPO_CODENAME}/}"
        printf " %s %8d %s\n" "$hash" "$size" "$relative_path"
    done >> "${temp_release}"

    echo "SHA1:" >> "${temp_release}"
    sudo find "dists/${REPO_CODENAME}" -type f ! -name "Release*" -exec sha1sum {} \; | while read -r hash file; do
        size=$(sudo stat -c%s "$file")
        relative_path="${file#dists/${REPO_CODENAME}/}"
        printf " %s %8d %s\n" "$hash" "$size" "$relative_path"
    done >> "${temp_release}"

    echo "SHA256:" >> "${temp_release}"
    sudo find "dists/${REPO_CODENAME}" -type f ! -name "Release*" -exec sha256sum {} \; | while read -r hash file; do
        size=$(sudo stat -c%s "$file")
        relative_path="${file#dists/${REPO_CODENAME}/}"
        printf " %s %8d %s\n" "$hash" "$size" "$relative_path"
    done >> "${temp_release}"

    sudo mv "${temp_release}" "${release_file}"

    # Set proper permissions on the Release file
    sudo chmod 644 "${release_file}"

    logger::info "Package indexes updated successfully"
}

# Function to validate repository structure
validate_repo() {
    local errors=0

    # Check required directories
    local required_dirs=(
        "${POOL_DIR}/${REPO_COMPONENT}"
        "${DISTS_DIR}/${REPO_CODENAME}/${REPO_COMPONENT}/binary-${REPO_ARCHITECTURE}"
        "${CONFIG_DIR}"
    )

    for dir in "${required_dirs[@]}"; do
        if [[ ! -d "$dir" ]]; then
            logger::error "Missing directory: $dir"
            ((errors++))
        fi
    done

    # Check Release file
    if [[ ! -f "${DISTS_DIR}/${REPO_CODENAME}/Release" ]]; then
        logger::error "Missing Release file: ${DISTS_DIR}/${REPO_CODENAME}/Release"
        ((errors++))
    fi

    # Check if repository is added to APT sources
    if [[ -f "$APT_SOURCES_FILE" ]]; then
        if grep -qF "${SOURCES_ENTRY}" "$APT_SOURCES_FILE" 2>/dev/null; then
            logger::info "Repository is properly configured in APT sources"
        else
            logger::warn "Repository file exists but entry not found: $APT_SOURCES_FILE"
            logger::warn "Expected entry: ${SOURCES_ENTRY}"
            logger::warn "Actual file contents:"
            cat "$APT_SOURCES_FILE" | sed 's/^/    /'
            ((errors++))
        fi
    else
        logger::warn "Repository not added to APT sources: $APT_SOURCES_FILE"
        ((errors++))
    fi

    if [[ $errors -eq 0 ]]; then
        logger::info "Repository validation passed"
        return 0
    else
        logger::error "Repository validation failed with $errors errors"
        return 1
    fi
}

# Function to show repository status
show_status() {
    logger::info "Local deb repository status:"
    echo "  Repository root: ${DEB_REPO_DIR}"
    echo "  Pool directory: ${POOL_DIR}"
    echo "  Distributions: ${DISTS_DIR}"
    echo "  Config: ${CONFIG_DIR}"
    echo "  Cache: ${CACHE_DIR}"
    echo

    # Count packages
    local package_count
    package_count=$(find "${POOL_DIR}" -name "*.deb" | wc -l 2>/dev/null || echo "0")
    echo "  Total packages: ${package_count}"

    # Show repository details
    echo "  Codename: ${REPO_CODENAME}"
    echo "  Component: ${REPO_COMPONENT}"
    echo "  Architecture: ${REPO_ARCHITECTURE}"
    echo

    # Show APT integration status
    echo "  APT Integration:"
    if [[ -f "$APT_SOURCES_FILE" ]]; then
        if grep -qF "${SOURCES_ENTRY}" "$APT_SOURCES_FILE" 2>/dev/null; then
            echo "    Status: ✓ Active"
            echo "    File: $APT_SOURCES_FILE"
        else
            echo "    Status: ✗ File exists but entry missing"
            echo "    File: $APT_SOURCES_FILE"
            echo "    Expected: ${SOURCES_ENTRY}"
            echo "    Actual contents:"
            cat "$APT_SOURCES_FILE" 2>/dev/null | sed 's/^/      /' || echo "      (unable to read file)"
        fi
    else
        echo "    Status: ✗ Not configured"
    fi
    echo "    Entry: ${SOURCES_ENTRY}"
}

# Function to show help
show_help() {
    cat << EOF
Usage: $0 [COMMAND]

Commands:
  init      Initialize repository structure and add to APT sources (default)
  update    Update package indexes
  status    Show repository status
  validate  Validate repository structure
  add-apt   Add repository to APT sources
  remove-apt Remove repository from APT sources
  help      Show this help message

Examples:
  $0 init          # Initialize repository and add to APT
  $0 update        # Update package indexes
  $0 status        # Show repository status
  $0 add-apt       # Add repository to APT sources
  $0 remove-apt    # Remove repository from APT sources

After initialization, you can:
  - Add packages with: deb-repo-add.sh add ./package.deb
  - Download packages with: deb-repo-add.sh download firefox
  - Install packages with: sudo apt install package-name
EOF
}

# Main function
main() {
    case "${1:-init}" in
        "init")
            # Clean up old repository location if it exists
            if [[ -d "{{ .chezmoi.homeDir }}/.local/share/deb" && ! -L "{{ .chezmoi.homeDir }}/.local/share/deb" ]]; then
                logger::warn "Found old repository in home directory. Moving to new location..."
                if [[ -d "{{ .chezmoi.homeDir }}/.local/share/deb/pool" ]]; then
                    # Backup existing packages if any
                    sudo mkdir -p "${DEB_REPO_DIR}/pool"
                    sudo cp -r "{{ .chezmoi.homeDir }}/.local/share/deb/pool/"* "${DEB_REPO_DIR}/pool/" 2>/dev/null || true
                fi
                rm -rf "{{ .chezmoi.homeDir }}/.local/share/deb"
                logger::info "Moved old repository data to new location"
            fi

            check_dependencies || exit 1
            init_repo_structure
            create_repo_config
            create_ftparchive_config
            create_sources_list_template
            create_gitignore
            create_keep_files
            set_permissions
            update_indexes
            add_to_apt_sources
            validate_repo
            show_status
            echo
            logger::info "Repository initialization complete!"
            logger::info "Repository location: ${DEB_REPO_DIR}"
            logger::info "User convenience link: ${USER_REPO_LINK}"
            logger::info "You can now add packages and install them using apt."
            ;;
        "update")
            update_indexes
            ;;
        "status")
            show_status
            ;;
        "validate")
            validate_repo
            ;;
        "add-apt")
            add_to_apt_sources
            ;;
        "remove-apt")
            remove_from_apt_sources
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        *)
            logger::error "Unknown command: $1"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
{{- else }}
echo "This script is only for Ubuntu systems"
exit 1
{{- end }}
