#!/bin/bash
# .chezmoiscripts/run_once_install-homebrew.sh.tmpl

exit 0

{{ if not (or (eq .chezmoi.os "darwin") (eq .chezmoi.os "linux")) -}}
echo "Unsupported OS: {{ .chezmoi.os }}"
exit 1
{{ end -}}

# Detect the operating system
is_macos() {
  [[ "{{ .chezmoi.os }}" == "darwin" ]]
}

is_linux() {
  [[ "{{ .chezmoi.os }}" == "linux" ]]
}

# Detect the Linux distribution
is_ubuntu() {
  if is_linux && command -v lsb_release >/dev/null 2>&1; then
    [[ "$(lsb_release -is)" == "Ubuntu" ]]
  else
    false
  fi
}

is_alma() {
  if is_linux && [ -f /etc/redhat-release ]; then
    grep -q "AlmaLinux" /etc/redhat-release
  else
    false
  fi
}

# Install dependencies
install_dependencies() {
  echo "Installing dependencies for Homebrew..."
  
  if is_ubuntu; then
    sudo apt-get update
    sudo apt-get install -y build-essential procps curl file git
  elif is_alma; then
    sudo dnf groupinstall -y 'Development Tools'
    sudo dnf install -y procps-ng curl file git
  elif is_macos; then
    # Check if Xcode Command Line Tools are installed
    if ! xcode-select -p &>/dev/null; then
      echo "Installing Xcode Command Line Tools..."
      xcode-select --install
      # Wait for the installation to complete
      echo "Please complete the Xcode Command Line Tools installation and then press any key to continue..."
      read -n 1
    fi
  else
    echo "Unsupported Linux distribution"
    exit 1
  fi
}

# Install Homebrew
install_homebrew() {
  if command -v brew &>/dev/null; then
    echo "Homebrew is already installed."
  else
    echo "Installing Homebrew..."
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Print information about shell configuration
    if is_linux; then
      if [[ -d /home/linuxbrew/.linuxbrew ]]; then
        echo "Homebrew installed successfully to /home/linuxbrew/.linuxbrew"
        echo "NOTE: To use Homebrew, you need to add the following to your shell configuration:"
        echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"'
      else
        echo "Homebrew installed successfully"
        echo "NOTE: To use Homebrew, you need to add the following to your shell configuration:"
        echo 'eval "$(/usr/local/bin/brew shellenv)"'
      fi
    elif is_macos; then
      if [[ -f /opt/homebrew/bin/brew ]]; then
        echo "Homebrew installed successfully to /opt/homebrew"
        echo "NOTE: To use Homebrew, you need to add the following to your shell configuration:"
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"'
      else
        echo "Homebrew installed successfully"
        echo "NOTE: To use Homebrew, you need to add the following to your shell configuration:"
        echo 'eval "$(/usr/local/bin/brew shellenv)"'
      fi
    fi
  fi
}

main() {
  install_dependencies
  install_homebrew
  
  # Test the installation
  if [[ -f /home/linuxbrew/.linuxbrew/bin/brew ]]; then
    echo "Verifying Homebrew installation..."
    /home/linuxbrew/.linuxbrew/bin/brew --version
  elif [[ -f /opt/homebrew/bin/brew ]]; then
    echo "Verifying Homebrew installation..."
    /opt/homebrew/bin/brew --version
  elif [[ -f /usr/local/bin/brew ]]; then
    echo "Verifying Homebrew installation..."
    /usr/local/bin/brew --version
  else
    echo "Homebrew installation could not be verified. Please check the output for errors."
    exit 1
  fi
  
  echo "Homebrew has been installed successfully."
  echo "IMPORTANT: Shell configuration changes are required to use Homebrew."
  echo "Please refer to the notes above about the required configuration changes."
}

main
